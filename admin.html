<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Catalog Guide — Admin</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{ --bg:#0b1020; --panel:#0f172a; --muted:#94a3b8; --text:#e5e7eb; --accent:#19C37D; --border:#27324a; }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(120deg,#0b1020,#111a33);color:var(--text)}
  header{position:sticky;top:0;z-index:5;background:linear-gradient(to bottom,rgba(11,16,32,.9),rgba(11,16,32,.6));backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  h1{font-size:20px;margin:0 0 6px}
  p.sub{margin:0;color:var(--muted)}
  .grid{display:grid;grid-template-columns:300px 1fr;gap:16px;margin-top:16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
  label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
  input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0b1226;color:var(--text)}
  input[type=password]{letter-spacing:.1em}
  .row{display:flex;gap:8px;align-items:center}
  .btn{border:1px solid var(--border);background:#0b1226;color:var(--text);padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:600}
  .btn:hover{outline:2px solid rgba(25,195,125,.18)}
  .btn.primary{background:#083a2a;border-color:#0c5e46}
  .btn.primary:hover{outline:2px solid rgba(25,195,125,.28)}
  .btn.danger{background:#2b0404;border-color:#581919}
  small.hint{color:var(--muted);display:block;margin-top:6px}
  .list{display:grid;gap:12px}
  .item{border:1px dashed var(--border);border-radius:12px;padding:12px;background:#0b1226}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .pill{border:1px solid var(--border);border-radius:999px;padding:4px 8px;font-size:11px;color:var(--muted)}
  .status{font-size:12px;color:var(--muted)}
  footer{padding:14px;text-align:center;color:var(--muted)}
  @media (max-width: 900px){ .grid{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Catalog Guide — Admin</h1>
    <p class="sub">Edit <code>cards.json</code> with a simple form. Token can be remembered on this device only.</p>
  </div>
</header>

<div class="wrap grid">
  <!-- LEFT: repo & auth -->
  <section class="card">
    <label>Repository Owner</label>
    <input id="owner" value="cookieemonsterr" />

    <label>Repository Name</label>
    <input id="repo" value="Tips-and-Tricks" />

    <label>File Path</label>
    <input id="path" value="cards.json" />

    <label>Branch</label>
    <input id="branch" value="main" />

    <label>GitHub Token (fine-grained; Contents: Read & Write; this repo only)</label>
    <div class="row">
      <input id="token" type="password" placeholder="ghp_..." style="flex:1" />
      <button class="btn" id="toggleToken" title="Show/hide">Show</button>
    </div>
    <div class="row">
      <label><input type="checkbox" id="remember" /> Remember token on this device</label>
      <button class="btn" id="clearToken">Clear saved</button>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn" id="loadSite">Load from Site</button>
      <button class="btn" id="loadRepo">Load from GitHub</button>
    </div>
    <small class="hint">Site = public JSON. GitHub = reads via API (gets file SHA for safe saving).</small>

    <div style="margin-top:12px" class="row">
      <button class="btn primary" id="save">Save to GitHub</button>
      <button class="btn" id="export">Download JSON</button>
    </div>
    <div style="margin-top:8px" class="status" id="status">Idle</div>
  </section>

  <!-- RIGHT: editor -->
  <section class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="row">
        <span class="pill" id="count">0 cards</span>
        <span class="pill" id="sha">sha: —</span>
      </div>
      <div class="row">
        <button class="btn" id="addCard">+ Add Card</button>
        <button class="btn danger" id="resetAll">Reset</button>
      </div>
    </div>
    <div class="list" id="list"></div>
  </section>
</div>

<footer>Tips: add tips one per line; links have label, url, type, emoji. Image fields are optional.</footer>

<script>
  // Where the public site reads data from (used by "Load from Site")
  const SITE_JSON = 'https://cookieemonsterr.github.io/Tips-and-Tricks/cards.json';

  // ===== helpers / globals =====
  const $ = (sel, el=document) => el.querySelector(sel);
  const statusEl = $("#status");
  const list = $("#list");
  const countEl = $("#count");
  const shaEl = $("#sha");
  const tokenEl = $("#token");
  const rememberEl = $("#remember");
  const toggleBtn = $("#toggleToken");
  const clearBtn = $("#clearToken");

  let state = { cards: [] };
  let fileSha = null;

  // Prefill saved token
  const saved = localStorage.getItem('tips_token');
  if (saved) { tokenEl.value = saved; rememberEl.checked = true; }

  toggleBtn.addEventListener('click', () => {
    tokenEl.type = tokenEl.type === 'password' ? 'text' : 'password';
    toggleBtn.textContent = tokenEl.type === 'password' ? 'Show' : 'Hide';
  });
  clearBtn.addEventListener('click', () => {
    localStorage.removeItem('tips_token');
    tokenEl.value = '';
    rememberEl.checked = false;
  });

  function setStatus(msg){ statusEl.textContent = msg; }
  function updateBadges(){
    countEl.textContent = `${state.cards.length} card${state.cards.length===1?'':'s'}`;
    shaEl.textContent = `sha: ${fileSha ? fileSha.slice(0,7) : '—'}`;
  }
  function escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // ===== card UI =====
  function cardToUI(card, idx){
    const item = document.createElement('div');
    item.className = 'item';
    item.innerHTML = `
      <div class="two">
        <div>
          <label>Title</label>
          <input data-k="title" value="${escapeHtml(card.title||'')}" />
        </div>
        <div>
          <label>Badge</label>
          <input data-k="badge" value="${escapeHtml(card.badge||'')}" />
        </div>
      </div>
      <div class="two">
        <div>
          <label>Updated</label>
          <input data-k="updated" value="${escapeHtml(card.updated||'')}" />
        </div>
        <div>
          <label>Tags (comma)</label>
          <input data-k="tags" value="${escapeHtml((card.tags||[]).join(', '))}" />
        </div>
      </div>
      <div class="two">
        <div>
          <label>Image URL (optional)</label>
          <input data-k="image" value="${escapeHtml(card.image||'')}" />
        </div>
        <div>
          <label>Image alt</label>
          <input data-k="image_alt" value="${escapeHtml(card.image_alt||'')}" />
        </div>
      </div>
      <div>
        <label>Tips (one per line)</label>
        <textarea data-k="tips" rows="4">${escapeHtml((card.tips||[]).join('\n'))}</textarea>
      </div>
      <div>
        <label>Links</label>
        <div class="list links"></div>
        <div class="row" style="margin-top:8px">
          <button class="btn" data-add-link>Add Link</button>
          <button class="btn danger" data-del-card>Delete Card</button>
          <span class="pill">#${idx+1}</span>
        </div>
      </div>
    `;

    const linksWrap = item.querySelector('.links');
    (card.links||[]).forEach((l)=>{
      const row = document.createElement('div');
      row.className = 'row';
      row.style.gap = '6px';
      row.style.marginTop = '6px';
      row.innerHTML = `
        <input placeholder="Label" data-k="label" value="${escapeHtml(l.label||'')}" />
        <input placeholder="URL" data-k="url" value="${escapeHtml(l.url||'')}" />
        <input placeholder="Type" data-k="type" value="${escapeHtml(l.type||'')}" />
        <input placeholder="Emoji" data-k="emoji" value="${escapeHtml(l.emoji||'')}" />
        <button class="btn danger" data-del-link>&times;</button>
      `;
      linksWrap.appendChild(row);
    });

    item.addEventListener('input', (e)=>{
      const t = e.target;
      const k = t.dataset.k;
      if(!k) return;
      if(k==='tags'){
        card.tags = t.value.split(',').map(s=>s.trim()).filter(Boolean);
      }else if(k==='tips'){
        card.tips = t.value.split('\n').map(s=>s.trim()).filter(Boolean);
      }else{
        card[k] = t.value;
      }
    });

    item.addEventListener('click', (e)=>{
      if(e.target.matches('[data-add-link]')){
        card.links = card.links||[];
        card.links.push({label:'',url:'',type:'',emoji:''});
        render();
      }
      if(e.target.matches('[data-del-link]')){
        const row = e.target.closest('.row');
        const i = Array.from(linksWrap.children).indexOf(row);
        card.links.splice(i,1);
        render();
      }
      if(e.target.matches('[data-del-card]')){
        if(confirm('Delete this card?')){ state.cards.splice(idx,1); render(); }
      }
    });

    return item;
  }

  function render(){
    list.innerHTML = '';
    state.cards.forEach((c,i)=> list.appendChild(cardToUI(c,i)));
    updateBadges();
  }

  function readRepoFields(){
    const token = tokenEl.value.trim();
    if (rememberEl.checked) localStorage.setItem('tips_token', token);
    else localStorage.removeItem('tips_token');
    return {
      owner:  document.getElementById('owner').value.trim(),
      repo:   document.getElementById('repo').value.trim(),
      path:   document.getElementById('path').value.trim() || 'cards.json',
      branch: document.getElementById('branch').value.trim() || 'main',
      token
    };
  }

  // ===== buttons =====
  document.getElementById('loadSite').addEventListener('click', async()=>{
    try{
      setStatus('Loading from site…');
      const res = await fetch(SITE_JSON+'?ts='+Date.now(), { cache:'no-cache' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const json = await res.json();
      if(!json.cards) throw new Error('Missing "cards" array');
      state = json; fileSha = null; render(); setStatus('Loaded from site.');
    }catch(err){ setStatus('Load failed: '+err.message); console.error(err); }
  });

  document.getElementById('loadRepo').addEventListener('click', async()=>{
    try{
      setStatus('Loading from GitHub…');
      const {owner, repo, path, branch, token} = readRepoFields();
      const api = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`;
      const headers = {'Accept':'application/vnd.github+json'};
      if(token) headers['Authorization'] = `Bearer ${token}`;
      const res = await fetch(api, { headers });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const meta = await res.json();
      const content = atob((meta.content||'').replace(/\n/g,''));
      const json = JSON.parse(content);
      if(!json.cards) throw new Error('Missing "cards" array');
      state = json; fileSha = meta.sha || null; render(); setStatus('Loaded from GitHub.');
    }catch(err){ setStatus('Load failed: '+err.message); console.error(err); }
  });

  document.getElementById('addCard').addEventListener('click', ()=>{
    state.cards.push({title:'',badge:'',updated:'',tags:[],image:'',image_alt:'',links:[],tips:[]});
    render();
  });

  document.getElementById('resetAll').addEventListener('click', ()=>{
    if(confirm('Clear all cards from the editor (not saved yet)?')){ state = {cards:[]}; render(); }
  });

  document.getElementById('export').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'cards.json';
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // ===== SAVE with SHA fix =====
  document.getElementById('save').addEventListener('click', async()=>{
    const {owner, repo, path, branch, token} = readRepoFields();
    if(!token){ alert('Paste or remember a GitHub token first.'); return; }

    try{
      setStatus('Saving…');

      // 1) Always fetch latest sha (authorized) to avoid 422
      const metaUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`;
      const metaRes = await fetch(metaUrl, {
        headers: {
          'Accept':'application/vnd.github+json',
          'Authorization': `Bearer ${token}`
        }
      });

      let sha = null;
      if (metaRes.status === 200) {
        const meta = await metaRes.json();
        sha = meta.sha || null;
      } else if (metaRes.status !== 404) {
        const t = await metaRes.text();
        throw new Error(`Could not fetch meta: ${metaRes.status} ${t.slice(0,200)}`);
      }

      // 2) Prepare JSON (UTF-8 safe base64)
      const contentB64 = btoa(unescape(encodeURIComponent(JSON.stringify(state, null, 2))));

      // 3) PUT create/update with sha when present
      const putUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
      const body = { message: `Update ${path} via Admin UI`, content: contentB64, branch };
      if (sha) body.sha = sha;

      const putRes = await fetch(putUrl, {
        method:'PUT',
        headers:{
          'Accept':'application/vnd.github+json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(body)
      });

      const txt = await putRes.text();
      if(!putRes.ok) throw new Error(`HTTP ${putRes.status}: ${txt.slice(0,200)}`);
      const out = JSON.parse(txt);
      fileSha = out?.content?.sha || null;
